/***************************************************************                                                                                                                      
** Author: NMINH.DUC                                                                                                                                                                                               
**********************Amendment History*************************
**                                                                                                                                                                                                                  
** Date            Author                Request     Modification                                            
** ----------     ---------              -------     ------------                                                              
** 2/9/2022                                        
****************************************************************/
SELECT CHDRPF.CHDRNUM      AS CONTRACTNO,
       PROPOSAL_.TTMPRCNO  AS APPLICATIONNO,
       TO_CHAR(TO_DATE(CHDRPF.OCCDATE, 'YYYYMMDD'),'DD/MM/YYYY') AS RISKCOMMENCEMENTDATE,
       BILLDESC.LONGDESC   AS BILLINGFREQUENCY,
       (
       	CASE 
       		WHEN CHDRPF.STATCODE = 'IF' THEN COVRPF.SUMINS
       		ELSE COVTPF.SUMINS
       	END 
       )                   AS SA,
       SRCEBUS             AS SOURCEOFBUZ,
       AGNTNUM             AS AGENT,
       CNTTYPE             AS PRODUCTCODE,
       UPPER(
       	TRIM(PO.LSURNAME) || ' ' || TRIM(PO.LMIDNAME) || ' ' || TRIM(PO.LGIVNAME)
       )                   AS PONAME,
       PO.CLTSEX           AS PO_GENDER,
       TO_CHAR(TO_DATE(PO.CLTDOB, 'YYYYMMDD'),'DD/MM/YYYY')           AS PO_DOB,
       PO.SECUITYNO        AS PO_IDNUM,
       POEXT.RINTERNET     AS POEMAIL,
       POEXT.RMBLPHONE     AS POPHONENO,
       UPPER(
       	TRIM(po.CLTADDR01) || ' ' || TRIM(WARD_.WARDNAME) || ' ' || TRIM(TOWN_.TOWNNAME) || ' ' || TRIM(PROV.PROVINCENAME)
       )                   AS ADDRESS,
       UPPER(
       	TRIM(LA.LSURNAME) || ' ' || TRIM(LA.LMIDNAME) || ' ' || TRIM(LA.LGIVNAME)
       )                   AS LANAME,
       LA.CLTSEX           AS LA_GENDER,
       TO_CHAR(TO_DATE(LA.CLTDOB, 'YYYYMMDD'),'DD/MM/YYYY')           AS LA_DOB,
       LA.SECUITYNO        AS LA_IDNUM,
       (
       	NVL(COVRPF.INSTPREM, 0) + NVL(COVRPF.SINGP, 0) + NVL(COVTPF.INSTPREM, 0) + NVL(COVTPF.SINGP, 0)
       )                   AS TOTAL_PREMIUM,
       CHDRPF.STATCODE     AS RISKSTATUS,
       POLDESC.LONGDESC       POLICY_STATUS,
       CHDRPF.BILLCHNL     AS PAYMENTMETHOD,
       NVL(COVRPF.RCESTRM, COVTPF.RCESTRM) AS RISKCESSTERM,
       NVL(COVRPF.PCESTRM, COVTPF.PCESTRM) AS PREMIUMCESSTERM,
       TO_CHAR(TO_DATE(NVL(COVRPF.RCESDTE, COVTPF.RCESDTE), 'YYYYMMDD'),'DD/MM/YYYY') AS RISKCESSDATE,
       TO_CHAR(TO_DATE(NVL(COVRPF.PCESDTE, COVTPF.PCESDTE), 'YYYYMMDD'),'DD/MM/YYYY') AS PREMIUMCESSDATE,
       TO_CHAR(TO_DATE(NVL(COVRPF.CRRCD, NULL), 'YYYYMMDD'),'DD/MM/YYYY') AS COVERAGERCD,
       TO_CHAR(TO_DATE(HPADPF.HPROPDTE, 'YYYYMMDD'),'DD/MM/YYYY') AS PROPOSALDATE,
       TO_CHAR(TO_DATE(
       	(
       		CASE HPADPF.PACKDATE
       			WHEN 99999999 THEN NULL
       			ELSE HPADPF.HOISSDTE
       		END 
       	),
       	'YYYYMMDD'
       ),'DD/MM/YYYY')                   AS ACK_DATE,
       TO_CHAR(TO_DATE(
       	(
       		CASE HPADPF.HOISSDTE
       			WHEN 99999999 THEN NULL
       			ELSE HPADPF.HOISSDTE
       		END 
       	),
       	'YYYYMMDD'
       ),'DD/MM/YYYY')                   AS FIRSTISSUEDATE
FROM   VM1DTA.CHDRPF
       LEFT JOIN VM1DTA.CLNTPF PO
            ON  PO.CLNTNUM = CHDRPF.COWNNUM
            AND PO.VALIDFLAG = '1'
       LEFT JOIN VM1DTA.CLEXPF POEXT
            ON  POEXT.CLNTNUM = PO.CLNTNUM
            AND POEXT.VALIDFLAG = '1'
       LEFT JOIN VM1DTA.LIFEPF
            ON  LIFEPF.CHDRNUM = CHDRPF.CHDRNUM
                --      AND LIFEPF.VALIDFLAG = '1'                               
       LEFT JOIN VM1DTA.CLNTPF LA
            ON  LA.CLNTNUM = LIFEPF.LIFCNUM
            AND LA.VALIDFLAG = '1'
       LEFT JOIN VM1DTA.COVRPF
            ON  COVRPF.CHDRNUM = CHDRPF.CHDRNUM
            AND COVRPF.VALIDFLAG = '1'
       LEFT JOIN VM1DTA.COVTPF
            ON  COVTPF.CHDRNUM = CHDRPF.CHDRNUM
       LEFT JOIN VM1DTA.PAYRPF
            ON  PAYRPF.CHDRNUM = CHDRPF.CHDRNUM
            AND PAYRPF.VALIDFLAG = '1'
       LEFT JOIN VM1DTA.HPADPF
            ON  HPADPF.CHDRNUM = CHDRPF.CHDRNUM
            AND HPADPF.VALIDFLAG <> '2'
       LEFT JOIN VM1DTA.TTRCPF PROPOSAL_
            ON  PROPOSAL_.CHDRNUM = CHDRPF.CHDRNUM
       LEFT JOIN VM1DTA.PROVINCEPF prov
            ON  PROV.PROVINCEID = po.PROVINCEID
       LEFT JOIN VM1DTA.TOWNPF town_
            ON  PO.TOWNID = TOWN_.TOWNID --AND TOWN_.PROVINCEID = po.PROVINCEID               
       LEFT JOIN VM1DTA.WARDPF ward_
            ON  PO.WARDID = ward_.WARDID --AND TOWN_.PROVINCEID = po.PROVINCEID               
       LEFT JOIN VM1DTA.DESCPF POLDESC
            ON  POLDESC.DESCITEM = CHDRPF.STATCODE
            AND POLDESC.DESCTABL = 'T3623'
            AND POLDESC.LANGUAGE = 'E'
            AND POLDESC.DESCCOY = 2
       LEFT JOIN VM1DTA.DESCPF BILLDESC
            ON  BILLDESC.DESCITEM = CHDRPF.BILLFREQ
            AND BILLDESC.DESCTABL = 'T3590'
            AND BILLDESC.LANGUAGE = 'E'
            AND BILLDESC.DESCCOY = 2
WHERE  1 = 1
-- AND CHDRPF.CHDRNUM = 10802401
-- AND  PROPOSAL_.TTMPRCNO = 'OPAN000802231'
ORDER BY
       CONTRACTNO DESC;



